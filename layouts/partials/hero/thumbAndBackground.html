{{ $disableImageOptimization := .Page.Site.Params.disableImageOptimization | default false }}

{{- $images := .Resources.ByType "image" -}}
{{- $background := $images.GetMatch "*background*" -}}

{{- if not $background }}
  {{- with .Params.backgroundImage -}}
    {{- $bg := . -}}
    {{- if or (strings.HasPrefix $bg "http:") (strings.HasPrefix $bg "https:") -}}
      {{ $background = resources.GetRemote $bg }}
    {{- else -}}
      {{/* try page bundle first, then assets */}}
      {{ $background = $images.GetMatch $bg }}
      {{ if not $background }}{{ $background = resources.Get $bg }}{{ end }}
    {{- end -}}
  {{- else -}}
    {{- with .Site.Params.defaultBackgroundImage -}}
      {{- $def := . -}}
      {{- if or (strings.HasPrefix $def "http:") (strings.HasPrefix $def "https:") -}}
        {{ $background = resources.GetRemote $def }}
      {{- else -}}
        {{/* try page bundle first, then assets */}}
        {{ $background = $images.GetMatch $def }}
        {{ if not $background }}{{ $background = resources.Get $def }}{{ end }}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{ end -}}

{{- if not $background }}{{ $background = $images.GetMatch "{*cover*,*thumbnail*}" }}{{ end -}}
{{- if not $background }}{{ $background = $images.GetMatch "*feature*" }}{{ end -}}
{{- $featured := $images.GetMatch "*feature*" -}}
{{- if not $featured }}{{ $featured = $images.GetMatch "{*cover*,*thumbnail*}" }}{{ end -}}
{{ if and .Params.featureimage (not $featured) }}
  {{- $url:= .Params.featureimage -}}
  {{- if or (strings.HasPrefix $url "http:") (strings.HasPrefix $url "https:") -}}
    {{ $featured = resources.GetRemote $url }}
  {{- else -}}
    {{/* try page bundle first, then assets */}}
    {{ $featured = $images.GetMatch $url }}
    {{ if not $featured }}{{ $featured = resources.Get $url }}{{ end }}
  {{- end -}}
{{ end }}
{{- if not $featured }}{{ $featured = $images.GetMatch "*background*" }}{{ end -}}

{{- if not $featured }}
  {{- with .Params.backgroundImage -}}
    {{- $bg := . -}}
    {{- if or (strings.HasPrefix $bg "http:") (strings.HasPrefix $bg "https:") -}}
      {{ $featured = resources.GetRemote $bg }}
    {{- else -}}
      {{/* try page bundle first, then assets */}}
      {{ $featured = $images.GetMatch $bg }}
      {{ if not $featured }}{{ $featured = resources.Get $bg }}{{ end }}
    {{- end -}}
  {{- else -}}
    {{- with .Site.Params.defaultBackgroundImage -}}
      {{- $def := . -}}
      {{- if or (strings.HasPrefix $def "http:") (strings.HasPrefix $def "https:") -}}
        {{ $featured = resources.GetRemote $def }}
      {{- else -}}
        {{/* try page bundle first, then assets */}}
        {{ $featured = $images.GetMatch $def }}
        {{ if not $featured }}{{ $featured = resources.Get $def }}{{ end }}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{ end -}}

{{ $isParentList := eq (.Scratch.Get "scope") "list" }}
{{ $shouldBlur := $.Params.layoutBackgroundBlur | default (or
  (and ($.Site.Params.article.layoutBackgroundBlur | default true) (not $isParentList))
  (and ($.Site.Params.list.layoutBackgroundBlur | default true) ($isParentList))
  )
}}

{{- with $featured -}}
  {{ if or $disableImageOptimization (strings.HasSuffix . ".svg") }}
    {{ with . }}
      <div
        class="w-full rounded-md h-36 md:h-56 lg:h-72 single_hero_basic nozoom"
        style="background-image:url({{ .RelPermalink }});"></div>
    {{ end }}
  {{ else }}
    {{ with .Resize (print ($.Site.Params.backgroundImageWidth | default "1200") "x") }}
      <div
        class="w-full rounded-md h-36 md:h-56 lg:h-72 single_hero_basic nozoom"
        style="background-image:url({{ .RelPermalink }});"></div>
    {{ end }}
  {{ end }}
{{- end -}}

{{- with $background -}}

  <div class="single_hero_background nozoom fixed inset-x-0 top-0 h-[800px]">
    {{ if or $disableImageOptimization (strings.HasSuffix . ".svg") }}
      {{ with . }}
        <img
          id="background-image-main"
          src="{{ .RelPermalink }}"
          alt="Background Image"
          class="absolute inset-0 h-full w-full object-cover">
      {{ end }}
    {{ else }}
      {{ with .Resize (print ($.Site.Params.backgroundImageWidth | default "1200") "x") }}
        <img
          id="background-image-main"
          src="{{ .RelPermalink }}"
          alt="Background Image"
          class="absolute inset-0 h-full w-full object-cover">
      {{ end }}
    {{ end }}
    <div
      class="from-neutral absolute inset-0 bg-gradient-to-t to-transparent mix-blend-normal dark:from-neutral-800"></div>
    <div
      class="from-neutral to-neutral absolute inset-0 bg-gradient-to-t opacity-30 mix-blend-normal dark:from-neutral-800 dark:to-neutral-800 dark:opacity-60"></div>
  </div>
{{- end -}}

{{ if $shouldBlur | default false }}
  <div
    id="background-blur"
    class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
  {{ $backgroundBlur := resources.Get "js/background-blur.js" }}
  {{ $backgroundBlur = $backgroundBlur | resources.Minify | resources.Fingerprint (.Site.Params.fingerprintAlgorithm | default "sha512") }}
  <script
    type="text/javascript"
    src="{{ $backgroundBlur.RelPermalink }}"
    integrity="{{ $backgroundBlur.Data.Integrity }}"
    data-target-id="background-blur"
    data-image-id="background-image-main"
    {{ with $background }}data-image-url="{{ .RelPermalink }}"{{ end }}></script>
{{ end }}
